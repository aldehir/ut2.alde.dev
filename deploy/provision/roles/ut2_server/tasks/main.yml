---
- name: Pull down server container
  containers.podman.podman_image:
    name: "{{ ut2_server_image }}"
    force: true
    pull: true
  become: true
  async: 900
  poll: 0
  register: ut2_server_pull_containers

- name: Wait for pull
  ansible.builtin.async_status:
    jid: "{{ ut2_server_pull_containers.ansible_job_id }}"
  become: true
  register: ut2_server_pull_containers_result
  until: ut2_server_pull_containers_result.finished
  retries: 90
  delay: 10

- name: Create a directory for shared files
  ansible.builtin.file:
    path: /var/lib/ut2004
    state: directory
    mode: "0755"
  become: true

- name: Generate an XAdmin.ini
  ansible.builtin.template:
    src: XAdmin.ini.j2
    dest: /var/lib/ut2004/XAdmin.ini
    mode: "0600"
  become: true

- name: Generate Kubernetes YAML file
  ansible.builtin.template:
    src: ut2-instance.yml.j2
    dest: /etc/containers/systemd/{{ ut2_server_instance_name }}.yml
    mode: "0644"
  register: ut2_generate_kubernetes_yaml_result
  become: true

- name: Generate Quadlet kube
  ansible.builtin.template:
    src: ut2-instance.kube.j2
    dest: /etc/containers/systemd/{{ ut2_server_instance_name }}.kube
    mode: "0644"
  register: ut2_generate_quadlet_result
  become: true

- name: Set restart fact
  ansible.builtin.set_fact:
    ut2_server_restart: >
      ut2_server_pull_containers_result.changed or
      ut2_generate_quadlet_result.changed or
      ut2_generate_kubernetes_yaml_result.changed

- name: Open up server ports
  ansible.posix.firewalld:
    port: "{{ item }}"
    zone: public
    state: enabled
    immediate: true
    permanent: true
  become: true
  loop:
    - "{{ ut2_server_game_port }}/udp"
    - "{{ ut2_server_query_port }}/udp"
    - "{{ ut2_server_gamespy_port }}/udp"
    - "{{ ut2_server_web_admin_port }}/tcp"

- name: Restart instance
  ansible.builtin.include_tasks: restart.yml
  when: ut2_server_restart
